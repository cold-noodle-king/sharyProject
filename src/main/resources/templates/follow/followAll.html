<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>Follow List</title>
	<!-- jQuery 로드 -->
	<script th:src="@{/js/jquery-3.7.1.min.js}"></script>

	<!-- 부트스트랩 CSS 로드 -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

	<!-- 헤더와 푸터용 스타일 -->
	<link href="../header/css/styles.css" rel="stylesheet">
	<link rel="stylesheet" href="../footer/css/styles.css">
	<link th:href="@{/css/mypage/sideBar.css}" rel="stylesheet">


<!--	<style>-->
<!--		body {-->
<!--			font-family: 'Arial', sans-serif;-->
<!--			background-color: #f0f0f0;-->
<!--			margin: 0;-->
<!--			padding: 20px;-->
<!--		}-->

<!--		h1, h2 {-->
<!--			text-align: center;-->
<!--			color: #333;-->
<!--			margin-bottom: 20px;-->
<!--		}-->

<!--		.container {-->
<!--			max-width: 800px;-->
<!--			margin: 0 auto;-->
<!--			background-color: #fff;-->
<!--			padding: 20px;-->
<!--			border-radius: 8px;-->
<!--			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);-->
<!--		}-->

<!--		/* 검색창 스타일 */-->
<!--		.search-bar {-->
<!--			text-align: center;-->
<!--			margin-bottom: 20px;-->
<!--		}-->

<!--		.search-bar input {-->
<!--			width: 50%;-->
<!--			padding: 10px;-->
<!--			border-radius: 5px;-->
<!--			border: 1px solid #ccc;-->
<!--		}-->

<!--		.tabs {-->
<!--			display: flex;-->
<!--			justify-content: center;-->
<!--			margin-bottom: 20px;-->
<!--		}-->

<!--		.tab {-->
<!--			padding: 10px 20px;-->
<!--			cursor: pointer;-->
<!--			background-color: #ddd;-->
<!--			border-radius: 5px 5px 0 0;-->
<!--			margin-right: 5px;-->
<!--			transition: background-color 0.3s;-->
<!--		}-->

<!--		.tab:hover {-->
<!--			background-color: #bbb;-->
<!--		}-->

<!--		.tab.active {-->
<!--			background-color: #5dade2;-->
<!--			color: white;-->
<!--		}-->

<!--		.tab-content {-->
<!--			display: none;-->
<!--		}-->

<!--		.tab-content.active {-->
<!--			display: block;-->
<!--		}-->

<!--		table {-->
<!--			width: 100%;-->
<!--			border-collapse: collapse;-->
<!--			margin-bottom: 20px;-->
<!--		}-->

<!--		th, td {-->
<!--			border: 1px solid #ddd;-->
<!--			padding: 10px;-->
<!--			text-align: center;-->
<!--			color: #333;-->
<!--		}-->

<!--		th {-->
<!--			background-color: #5dade2;-->
<!--			color: white;-->
<!--		}-->

<!--		button {-->
<!--			background-color: #5dade2;-->
<!--			color: white;-->
<!--			border: none;-->
<!--			padding: 5px 10px;-->
<!--			border-radius: 5px;-->
<!--			font-size: 14px;-->
<!--			cursor: pointer;-->
<!--			transition: background-color 0.3s ease;-->
<!--		}-->

<!--		button:hover {-->
<!--			background-color: #3498db;-->
<!--		}-->
<!--	</style>-->


	<script th:inline="javascript">
		var currentUserId = /*[[${#authentication.name}]]*/ 'anonymousUser';
	</script>

	<script>
		// 팔로우 확인 대화상자 처리
		function confirmFollow(event, form) {
			event.preventDefault();
			const result = confirm('해당 사용자를 팔로우 하시겠습니까?');

			if (result) {
				form.submit();
			}
		}

		// 언팔로우 확인 대화상자 처리
		function confirmUnfollow(event, form) {
			event.preventDefault();
			const result = confirm('팔로우를 취소하시겠습니까?');

			if (result) {
				form.submit();
			}
		}

		// 탭 전환 함수
		function openTab(tabName) {
			var i, tabContent, tablinks;
			tabContent = document.getElementsByClassName("tab-content");

			for (i = 0; i < tabContent.length; i++) {
				tabContent[i].classList.remove("active");
				tabContent[i].style.display = "none";
			}

			tablinks = document.getElementsByClassName("tab");
			for (i = 0; i < tablinks.length; i++) {
				tablinks[i].classList.remove("active");
			}

			document.getElementById(tabName).classList.add("active");
			document.getElementById(tabName).style.display = "block";

			// 탭 전환 시 검색 입력란과 테이블 초기화
			document.getElementById('search-input').value = '';
			if (tabName === 'allUsers') {
				document.getElementById('allUsersTableBody').innerHTML = '';
			}
		}

		// 사용자 검색 함수
		function searchUsers() {
			const searchTerm = document.getElementById('search-input').value.toLowerCase();

			const activeTab = document.querySelector('.tab-content.active');

			if (!activeTab) return;

			const activeTabId = activeTab.getAttribute('id');

			if (activeTabId === 'allUsers') {
				if (searchTerm.trim() === '') {
					document.getElementById('allUsersTableBody').innerHTML = '';
					return;
				}

				// AJAX 요청으로 일치하는 사용자 가져오기
				fetch('/searchUsers?query=' + encodeURIComponent(searchTerm))
						.then(response => response.json())
						.then(data => {
							const tableBody = document.getElementById('allUsersTableBody');
							tableBody.innerHTML = '';

							data.forEach((user, index) => {
								console.log(user); // 디버깅을 위해 사용자 객체를 콘솔에 출력

								const row = document.createElement('tr');

								// 순번
								const cell1 = document.createElement('td');
								cell1.textContent = index + 1;
								row.appendChild(cell1);

								// 사용자 ID
								const cell2 = document.createElement('td');
								cell2.textContent = user.memberId;
								row.appendChild(cell2);

								// 닉네임
								const cell3 = document.createElement('td');
								cell3.textContent = user.nickname;
								row.appendChild(cell3);

								// 팔로우 또는 언팔로우 버튼
								const cell4 = document.createElement('td');
								const form = document.createElement('form');
								form.method = 'post';
								form.onsubmit = function(event) {
									if (user.isFollowing) {
										return confirmUnfollow(event, this);
									} else {
										return confirmFollow(event, this);
									}
								};

								const inputFollowerId = document.createElement('input');
								inputFollowerId.type = 'hidden';
								inputFollowerId.name = 'followerId';
								inputFollowerId.value = currentUserId;
								form.appendChild(inputFollowerId);

								const inputFollowingId = document.createElement('input');
								inputFollowingId.type = 'hidden';
								inputFollowingId.name = 'followingId';
								inputFollowingId.value = user.memberId;
								form.appendChild(inputFollowingId);

								const button = document.createElement('button');
								button.type = 'submit';

								if (user.isFollowing) {
									form.action = '/follow/delete'; // 언팔로우 액션
									button.textContent = '팔로우 취소';
								} else {
									form.action = '/followUser'; // 팔로우 액션
									button.textContent = '팔로우 하기';
								}

								form.appendChild(button);
								cell4.appendChild(form);
								row.appendChild(cell4);

								tableBody.appendChild(row);
							});
						})
						.catch(error => {
							console.error('사용자 가져오기 오류:', error);
						});
			} else {
				// 다른 탭에서의 검색 처리
				const rows = activeTab.querySelectorAll('tbody tr');

				rows.forEach(row => {
					const text = row.textContent.toLowerCase();
					if (text.includes(searchTerm)) {
						row.style.display = '';
					} else {
						row.style.display = 'none';
					}
				});
			}
		}

		// 페이지 로드 시 'followers' 탭을 자동으로 열기
		window.onload = function () {
			openTab('followers');
		}
	</script>

</head>
<body onload="openTab('followers')">

<div class="container">

	<header th:replace="~{fragments/header :: header}"></header>

	<h1>[ Social ]</h1>

	<!-- 검색창 추가 (검색어 입력 후 검색 버튼 누를 때 서버에 검색 요청) -->
	<div class="search-bar">
		<input type="text" id="search-input" placeholder="검색어를 입력하세요" onkeyup="searchUsers()" />
	</div>

	<div class="tabs">
		<div id="followers-tab" class="tab active" onclick="openTab('followers')">팔로워</div>
		<div id="following-tab" class="tab" onclick="openTab('following')">팔로잉</div>
		<div id="allUsers-tab" class="tab" onclick="openTab('allUsers')">전체 사용자</div> <!-- 전체 사용자 탭 추가 -->
	</div>

	<!-- 팔로워 탭 콘텐츠 -->
	<div id="followers" class="tab-content active">
		<h2>나를 팔로우하는 사람들</h2>
		<table>
			<thead>
			<tr>
				<th>목록</th>
				<th>팔로워 ID</th>
				<!--<th>날짜</th>-->
				<th>채팅</th>
				<th>쪽지</th>
			</tr>
			</thead>
			<tbody>
			<tr th:each="follow, iterStat : ${followers}">
				<td th:text="${iterStat.count}">1</td>
				<td th:text="${follow.followerId}">followerId</td>
				<!--<td th:text="${#temporals.format(follow.followDate, 'yyyy-MM-dd HH:mm:ss')}">followDate</td>-->
				<td>
					<form th:action="@{/chat/room}" method="get">
						<input type="hidden" name="participant1Id" th:value="${#authentication.name}" />
						<input type="hidden" name="participant2Id" th:value="${follow.followerId}" />
						<button type="submit">채팅</button>
					</form>
				</td>
				<td>
					<form th:action="@{/SseHome}" method="get">
						<input type="hidden" name="recipientId" th:value="${follow.followerId}" />
						<button type="submit">쪽지</button>
					</form>
				</td>
			</tr>
			</tbody>
		</table>
	</div>

	<!-- 팔로잉 탭 콘텐츠 -->
	<div id="following" class="tab-content">
		<h2>내가 팔로우하고 있는 사람들</h2>
		<table>
			<thead>
			<tr>
				<th>목록</th>
				<th>팔로잉 ID</th>
				<!--<th>날짜</th>-->
				<th>채팅</th>
				<th>쪽지</th>
				<th>팔로우 취소</th>

			</tr>
			</thead>
			<tbody>
			<tr th:each="follow, iterStat : ${following}">
				<td th:text="${iterStat.count}">1</td>
				<td th:text="${follow.followingId}">followingId</td>
				<!--<td th:text="${#temporals.format(follow.followDate, 'yyyy-MM-dd HH:mm:ss')}">followDate</td>-->
				<td>
					<form th:action="@{/chat/room}" method="get">
						<input type="hidden" name="participant1Id" th:value="${#authentication.name}" />
						<input type="hidden" name="participant2Id" th:value="${follow.followingId}" />
						<button type="submit">채팅</button>
					</form>
				</td>
				<td>
					<form th:action="@{/SseHome}" method="get">
						<input type="hidden" name="recipientId" th:value="${follow.followerId}" />
						<button type="submit">쪽지</button>
					</form>
				</td>

				<td>
					<form action="/follow/delete" method="post" onsubmit="confirmUnfollow(event, this)">
						<input type="hidden" name="followingId" th:value="${follow.followingId}" />
						<button type="submit">팔로우 취소</button>
					</form>
				</td>
			</tr>
			</tbody>
		</table>
	</div>

	<!-- 전체 사용자 탭 콘텐츠 -->
	<div id="allUsers" class="tab-content">
		<h2>전체 사용자 목록</h2>
		<table>
			<thead>
			<tr>
				<th>목록</th>
				<th>사용자 ID</th>
				<th>닉네임</th>
				<th>팔로우 하기</th>
			</tr>
			</thead>
			<!-- JavaScript로 동적으로 데이터를 추가하기 위해 ID를 가진 빈 tbody 추가 -->
			<tbody id="allUsersTableBody">
			<!-- 여기에서 행이 동적으로 추가됩니다 -->
			</tbody>
		</table>
	</div>
</div>

<!-- 푸터 부분 불러오기 -->
<footer th:replace="~{fragments/footer :: footer}"></footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- FontAwesome 아이콘 로드 -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</body>
</html>
