<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>ê³µìœ  ë‹¤ì´ì–´ë¦¬ ë‘˜ëŸ¬ë³´ê¸°</title>

    <!-- jQuery ë¡œë“œ -->
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>

    <!-- cssíŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link href="/css/share/MyNote.css" rel="stylesheet">

    <!-- moment.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script>
        $(document).ready(function (){

            // ì œëª© í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬
            $(document).on('click', '.view-note', function(e) {
                e.preventDefault();

                // í´ë¦­ëœ ë…¸íŠ¸ì˜ ë²ˆí˜¸ì™€ ì¢‹ì•„ìš” ìˆ˜ë¥¼ ê°€ì ¸ì˜¤ê¸°
                let noteNum = $(this).data('note-num');
                let likeCnt = $(this).data('like-cnt');

                // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
                $('#cnt').val(likeCnt);
                $('#likeCnt').html(likeCnt);

                // Ajaxë¡œ ì„œë²„ì—ì„œ ë…¸íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìš”ì²­
                $.ajax({
                    url: '/share/viewNote/' + noteNum, // ë…¸íŠ¸ ì •ë³´ ìš”ì²­ URL
                    type: 'GET',
                    success: function(response) {
                        // ë°ì´í„° ë¶„ë¦¬
                        var note = response.shareNote;
                        var likeResponse = response.likeResponse;

                        // ëª¨ë‹¬ì— ë°ì´í„° ì„¤ì •
                        $('#noteModalLabel').text(note.shareNoteTitle); // ë…¸íŠ¸ ì œëª© ì„¤ì •
                        $('#nickname').text(note.nickname); // ì‘ì„±ì ì„¤ì •

                        // ì‘ì„±ì¼ ì„¤ì •
                        let createdDate = new Date(note.createdDate);
                        let formattedCreatedDate = `${createdDate.getFullYear()}.${('0' + (createdDate.getMonth() + 1)).slice(-2)}.${('0' + createdDate.getDate()).slice(-2)}`;
                        $('#createdDate').text(formattedCreatedDate);

                        // ìœ„ì¹˜ ì •ë³´ ì„¤ì •
                        var location = note.location.replace(/\(.*?\)/g, ''); // ê´„í˜¸ ì œê±°
                        $('#noteLocation').text(location);

                        // ì‘ì„±ì¼ ì„¤ì •
                        var diaryDate = new Date(note.diaryDate);
                        var formattedDiaryDate = `${diaryDate.getFullYear()}ë…„ ${(diaryDate.getMonth() + 1)}ì›” ${diaryDate.getDate()}ì¼`;
                        $('#noteDate').text(formattedDiaryDate);

                        // ê°ì • ì•„ì´ì½˜ ì„¤ì •
                        var emotionIcon;
                        switch(note.emotionName) {
                            case 'ê¸°ì¨': emotionIcon = 'ğŸ˜Š'; break;
                            case 'ìŠ¬í””': emotionIcon = 'ğŸ˜¢'; break;
                            case 'í™”ë‚¨': emotionIcon = 'ğŸ˜ '; break;
                            case 'ë†€ëŒ': emotionIcon = 'ğŸ˜®'; break;
                            case 'ë‘ë ¤ì›€': emotionIcon = 'ğŸ˜±'; break;
                            case 'ì‚¬ë‘': emotionIcon = 'â¤ï¸'; break;
                            default: emotionIcon = 'ğŸ˜'; break;
                        }
                        $('#noteEmotion').html(emotionIcon);

                        // ì¢‹ì•„ìš” ì •ë³´ ì—…ë°ì´íŠ¸
                        $('#cnt').val(likeResponse.cnt);
                        $('#likeCnt').text(likeResponse.cnt);

                        // ê°ì •ë³„ ì¢‹ì•„ìš” ìˆ˜ ì„¤ì •
                        $('#joyCnt').html(likeResponse.joyCnt);
                        $('#loveCnt').html(likeResponse.loveCnt);
                        $('#sadCnt').html(likeResponse.sadCnt);
                        $('#angryCnt').html(likeResponse.angryCnt);
                        $('#wowCnt').html(likeResponse.wowCnt);

                        // ë…¸íŠ¸ ë‚´ìš© ì„¤ì •
                        $('#noteContents').text(note.contents);

                        // í•´ì‹œíƒœê·¸ ì„¤ì •
                        if (note.hashtags && note.hashtags.length > 0) {
                            var hashtagsText = note.hashtags.join(', ');
                            $('#noteHashtags').text(hashtagsText);
                        } else {
                            $('#noteHashtags').text('í•´ì‹œíƒœê·¸ ì—†ìŒ');
                        }

                        // ì´ë¯¸ì§€ê°€ ìˆì„ ê²½ìš° ì´ë¯¸ì§€ í‘œì‹œ, ì—†ìœ¼ë©´ ìˆ¨ê¹€
                        if (note.fileName && note.fileName.trim() !== "") {
                            $('#personalNoteImage').attr('src', '/uploads/' + encodeURIComponent(note.fileName)).show();
                        } else {
                            $('#personalNoteImage').hide();
                        }

                        // ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì •
                        if (note.noteTemplate && note.noteTemplate.noteName) {
                            var backgroundImageUrl = '/images/' + encodeURIComponent(note.noteTemplate.noteName) + '.png';
                            $('#noteContentModal').css({
                                'background-image': 'url(' + backgroundImageUrl + ')',
                                'background-size': 'cover',
                                'background-position': 'center',
                                'background-repeat': 'no-repeat'
                            });
                        } else {
                            $('#noteContentModal').css('background-image', 'none');
                        }

                        // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
                        if (note.profilePicture && note.profilePicture.trim() !== "") {
                            $('.profile-image img').attr('src', note.profilePicture);
                        } else {
                            $('.profile-image img').attr('src', '/images/default_profile.png');
                        }

                        // ëª¨ë‹¬ ì—´ê¸°
                        $('#noteModal').modal('show');
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        alert('ë…¸íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        console.log('Error Status: ' + textStatus);
                        console.log('Error Thrown: ' + errorThrown);
                        console.log('Response Text: ' + jqXHR.responseText);
                    }
                });
                // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
                commentList(noteNum);
            });
        });
        function commentList(noteNum) {
            $.ajax({
                url: '/reply/commentList',
                type: 'post',
                data: { noteNum: noteNum },
                dataType: 'json',
                success: function(list) {
                    console.log(list);
                    $('.commentTbody').empty();
                    $(list).each(function(i, com) {
                        // ëŒ“ê¸€ ì‘ì„±ìê°€ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì™€ ê°™ì€ì§€ í™•ì¸
                        let isCurrentUser = (authenticatedUserId === com.memberId);
                        let deleteIconHtml = '';
                        if (isCurrentUser) {
                            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì¼ ê²½ìš° ì‚­ì œ ì•„ì´ì½˜ í‘œì‹œ
                            deleteIconHtml = `<img src="/images/xicon.png" style="width: 15px; height: 15px;" alt="ì‚­ì œ">`;
                        }

                        // ëŒ“ê¸€ HTML êµ¬ì„±
                        let html = `
                    <tr>
                        <td style="width: 80px">${com.nickname}</td>
                        <td style="width: 230px">${com.contents}</td>
                        <td>${moment(com.createdDate).format('YY.MM.DD')}</td>
                        <td><a href="#" class="delReply" data-note-num="${com.shareNoteNum}" data-reply-num="${com.replyNum}">${deleteIconHtml}</a></td>
                    </tr>
                `;
                        $('.commentTbody').append(html);
                    });

                    // ì‚­ì œ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    $('.delReply').off('click').on('click', function(e) {
                        e.preventDefault(); // ê¸°ë³¸ ë§í¬ ë™ì‘ ë°©ì§€
                        let noteNum = $(this).data('note-num'); // ë…¸íŠ¸ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
                        let replyNum = $(this).data('reply-num'); // ëŒ“ê¸€ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
                        let trElement = $(this).closest('tr'); // í•´ë‹¹ tr ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

                        // ì‚­ì œ í™•ì¸ ì•Œë¦¼
                        if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            return;
                        } else {
                            $.ajax({
                                url: '/reply/delete',
                                type: 'post',
                                data: { noteNum: noteNum, replyNum: replyNum },
                                success: function() {
                                    trElement.css('display', 'none'); // í•´ë‹¹ trì„ ìˆ¨ê¹€
                                },
                                error: function() {
                                    alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                }
                            });
                        }
                    });
                }
            });
        }


    </script>

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS ë¡œë“œ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- í—¤ë”ì™€ í‘¸í„°ìš© ìŠ¤íƒ€ì¼ -->
    <link th:href="@{/header/css/styles.css}" rel="stylesheet">
    <link th:href="@{/footer/css/styles.css}" rel="stylesheet">

    <!-- MyNote í˜ì´ì§€ ì „ìš© CSS íŒŒì¼ -->
    <link href="/css/share/MyNote.css" rel="stylesheet">

    <!-- Googleí°íŠ¸ ì‚¬ìš© ë§í¬ -->
    <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css' rel='stylesheet' type='text/css'>
</head>
<body>
<!-- í—¤ë” ë¶€ë¶„ ë¶ˆëŸ¬ì˜¤ê¸° -->
<div th:replace="~{fragments/header :: header}"></div>
<br>
<br>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div id="my-note-main" class="container mt-5">
    <div>
        <h2>ëŒ“ê¸€ ê´€ë¦¬</h2>
    </div>

    <div>
        <table>
            <thead>
                <tr>
                    <td>No.</td>
                    <td>ë…¸íŠ¸ ì´ë¦„</td>
                    <td>ë‚´ìš©</td>
                    <td>ì‘ì„±ì</td>
                    <td>ì‘ì„±ì¼</td>
                    <td></td>
                    <td></td>
                </tr>
            </thead>
            <tbody>
                <tr th:each="note, i : ${replyList}">
                    <td th:text="${note.replyNum}"></td>
                    <td>
                        <a href="#" class="view-note"
                           th:data-note-num="${note.shareNoteNum}">
                            <span th:text="${note.shareNoteTitle}"></span>
                        </a>
                    </td>
                    <td th:text="${note.contents}"></td>
                    <td th:text="${note.nickname}"></td>
                    <td th:text="${#temporals.format(note.createdDate, 'yyyy.MM.dd HH:mm:ss')}"></td>
                    <td><button>ì‚­ì œ</button></td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xxl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalLabel">ë…¸íŠ¸ ì œëª©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- ë…¸íŠ¸ í…œí”Œë¦¿ ì´ë¯¸ì§€ ë°°ê²½ìœ¼ë¡œ ì„¤ì • -->
            <div class="modal-body" id="noteContentModal" style="background-size: cover; background-repeat: no-repeat;">
                <!-- ì½˜í…ì¸  ì „ì²´ë¥¼ ë¬¶ëŠ” div -->
                <div class="content-wrapper">

                    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ë° ìœ„ì¹˜/ë‚ ì§œ/ê°ì • ì„¹ì…˜ -->
                    <div class="d-flex align-items-center mb-4">
                        <div class="profile-image me-3">
                            <img src="/images/profile.png" class="rounded-circle" width="50" height="50" alt="í”„ë¡œí•„">
                        </div>
                        <div class="w-100">

                            <div class="date-emotion-section">
                                <span id="nickname"></span> <span>ì‘ì„±ì¼: <span id="createdDate"></span></span> <p><span id="noteDate">[ì‘ì„±ì¼]</span> <!-- ì‘ì„±ì¼ í…ìŠ¤íŠ¸ -->
                                <span id="noteEmotion" class="ms-3">[ê°ì •]</span></p> <!-- ê°ì • í…ìŠ¤íŠ¸ -->
                            </div>
                            <p id="noteLocation">[ìœ„ì¹˜]</p> <!-- ìœ„ì¹˜ í…ìŠ¤íŠ¸ (ì¶”í›„ ìˆ˜ì • ê°€ëŠ¥) -->
                        </div>
                    </div>

                    <!-- ì´ë¯¸ì§€ ì„¹ì…˜ -->
                    <div class="image-section">
                        <img src="" alt="ë…¸íŠ¸ ë‚´ìš© ì´ë¯¸ì§€" id="personalNoteImage" style="display: none;"> <!-- ì²˜ìŒì—ëŠ” ìˆ¨ê¸´ ìƒíƒœ -->
                    </div>

                    <!-- ë‚´ìš© ì„¹ì…˜ -->
                    <div class="content-section">
                        <p id="noteContents">[ë‚´ìš©]</p> <!-- ë…¸íŠ¸ ë‚´ìš© í…ìŠ¤íŠ¸ -->
                    </div>

                    <!-- í•´ì‹œíƒœê·¸ ì„¹ì…˜ -->
                    <div class="hashtag-section">
                        <p id="noteHashtags">[í•´ì‹œíƒœê·¸]</p> <!-- í•´ì‹œíƒœê·¸ í…ìŠ¤íŠ¸ -->
                    </div>

                    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ ì„¹ì…˜ -->
                    <div id="likeBox">
                        <input type="hidden" id="cnt">
                        <div class="emoji-buttons">
                            <span class="likeBtn" data-emoji="1">ğŸ˜Š</span><span id="joyCnt"></span>
                            <span class="likeBtn" data-emoji="2">ğŸ˜</span><span id="loveCnt"></span>
                            <span class="likeBtn" data-emoji="3">ğŸ˜¢</span><span id="sadCnt"></span>
                            <span class="likeBtn" data-emoji="4">ğŸ˜¡</span><span id="angryCnt"></span>
                            <span class="likeBtn" data-emoji="5">ğŸ˜®</span><span id="wowCnt"></span>
                        </div>
                        <p>ê³µê°â¤ï¸<span id="likeCnt"></span></p>
                    </div>

                    <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì„¹ì…˜ -->
                    <div>
                        <button class="update">ìˆ˜ì •</button>
                        <button class="delete">ì‚­ì œ</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- í‘¸í„° ë¶€ë¶„ ë¶ˆëŸ¬ì˜¤ê¸° -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© JS ë¡œë“œ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ë…¸íŠ¸ ë³´ê¸° JS -->
<script th:src="@{/js/share/viewNote.js}"></script>
</body>
</html>
